<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daftar Mouthgasm Crunchy</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-rose-100 to-amber-50 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md p-6 bg-white rounded-2xl shadow-md border border-rose-200">
    <h2 class="text-2xl font-bold text-center text-rose-600 mb-4">Daftar Mouthgasm Crunchy</h2>

    <form id="registerForm" class="space-y-4">
      <input type="text" id="nama" name="nama" placeholder="Nama Penuh" required
        class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-rose-400" />
      
      <input type="text" id="telefon" name="telefon" placeholder="No Telefon" required
        class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-rose-400" />
      
      <input type="email" id="email" name="email" placeholder="Email" required
        class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-rose-400" />
      
      <input type="text" id="referral" name="referral" placeholder="Kod Referral (jika ada)"
        class="w-full px-4 py-2 border rounded-xl uppercase focus:outline-none focus:ring-2 focus:ring-rose-400" />
      
      <button type="submit"
        class="w-full bg-rose-600 hover:bg-rose-700 text-white font-semibold py-2 rounded-xl transition">
        Daftar Sekarang
      </button>
    </form>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabaseUrl = "https://qdyojftztydvhyjbdnaq.supabase.co";
    const supabaseKey = "***REMOVED***";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const form = document.getElementById("registerForm");

    // üéØ Prefill kod referral dari URL
    const params = new URLSearchParams(window.location.search);
    const refCode = params.get("ref");
    if (refCode) {
      document.getElementById("referral").value = refCode.toUpperCase();
    }

    function getNextBatch(referralCode) {
      if (!referralCode) return "A";
      const lastChar = referralCode.slice(-1).toUpperCase();
      if (/^[A-Z]$/.test(lastChar)) {
        return String.fromCharCode(lastChar.charCodeAt(0) + 1);
      } else if (/^[A-Z]{2}$/.test(lastChar)) {
        return "AA";
      } else {
        return "A";
      }
    }

    function generateRandomNumber(length = 5) {
      const max = Math.pow(10, length);
      return Math.floor(Math.random() * max).toString().padStart(length, "0");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nama = form.nama.value.trim();
      const telefon = form.telefon.value.trim();
      const email = form.email.value.trim();
      const referral = form.referral.value.trim().toUpperCase();

      const batch = getNextBatch(referral);
      const randomNo = generateRandomNumber();
      const pendaftar_id = `MC${randomNo}${batch}`;

      const { error } = await supabase.from("pendaftar").insert([{
        nama,
        telefon,
        email,
        referral,
        pendaftar_id,
        batch
      }]);

      if (error) {
        alert("‚ùå Pendaftaran gagal: " + error.message);
      } else {
        localStorage.setItem("pendaftar_id", pendaftar_id);
        localStorage.setItem("email", email);
        localStorage.setItem("nama", nama);
        localStorage.setItem("batch", batch);
        window.location.href = "thank.html";
      }
    });
  </script>
</body>
</html>