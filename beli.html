<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulator Pembelian</title>
</head>
<body>
  <h2>Simulator Pembelian</h2>

  <form id="beli-form">
    <label for="pendaftar_id">ID Pendaftar:</label><br />
    <input type="text" id="pendaftar_id" name="pendaftar_id" required /><br /><br />

    <label for="jumlah">Jumlah Pembelian (RM):</label><br />
    <input type="number" id="jumlah" name="jumlah" required /><br /><br />

    <button type="submit">Rekod Pembelian</button>
  </form>

  <p id="status"></p>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://pqomqlhtkktkavbzwifq.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxb21xbGh0a2t0a2F2YnppZmEiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcxMDM2Mjc2NiwiZXhwIjoyMDY5OTM4NzY2fQ.rMgptGEXD3cs93M5n7LuDAKrFSmaV27ZJlGJZ-oz3SM'

    const supabase = createClient(supabaseUrl, supabaseKey)

    document.getElementById("beli-form").addEventListener("submit", async (e) => {
      e.preventDefault()

      const pendaftar_id = document.getElementById("pendaftar_id").value.trim()
      const jumlah = parseFloat(document.getElementById("jumlah").value)

      const { error } = await supabase.from("pembelian").insert([
        {
          pendaftar_id,
          jumlah,
        },
      ])

      if (error) {
        document.getElementById("status").innerText = "‚ùå Gagal rekod pembelian: " + error.message
        return
      }

      document.getElementById("status").innerText = "‚úÖ Berjaya rekod pembelian!"

      const { error: rpcError } = await supabase.rpc("update_pendaftar_info", {
        target_id: pendaftar_id
      })

      if (rpcError) {
        document.getElementById("status").innerText += "\n‚ö†Ô∏è RPC error: " + rpcError.message
      } else {
        document.getElementById("status").innerText += "\nüìà Info referrer berjaya dikemaskini!"
      }

      document.getElementById("beli-form").reset()
    })
  </script>
</body>
</html>