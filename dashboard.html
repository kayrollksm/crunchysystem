<!DOCTYPE html><html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Referral</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; font-family: Arial, sans-serif; }
    .btn-custom { margin-right: 5px; }
    .highlight { color: purple; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container text-center">
    <p>Selamat datang <span class="highlight" id="user-name"></span> | ID: <span class="highlight" id="user-id"></span></p>
    <h3 class="mb-4">Dashboard Referral</h3><div class="table-responsive">
  <table class="table table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Rank</th>
        <th>Nama</th>
        <th>ID</th>
        <th>Referral</th>
        <th>Jualan</th>
        <th>Tier</th>
        <th>Komisen</th>
        <th>Override</th>
      </tr>
    </thead>
    <tbody id="ranking-table">
      <tr><td colspan="8">Loading...</td></tr>
    </tbody>
  </table>
</div>

<button class="btn btn-danger" onclick="logout()">Log Keluar</button>

  </div>  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://xyzcompany.supabase.co'; // GANTI DENGAN URL PROJECT KAU
    const supabaseKey = 'YOUR_SUPABASE_API_KEY'; // GANTI DENGAN KEY KAU
    const supabase = createClient(supabaseUrl, supabaseKey);

    const userData = JSON.parse(localStorage.getItem('user'));
    if (!userData) window.location.href = 'index.html';

    document.getElementById('user-name').textContent = userData.name;
    document.getElementById('user-id').textContent = userData.pendaftar_id;

    const komisenByTier = {
      1: 10,
      2: 13,
      3: 15,
      4: 18,
      5: 20
    };

    async function getDashboardData() {
      const { data: allPendaftar, error } = await supabase.from('pendaftar').select('*');
      if (error) return alert('Gagal ambil data pendaftar.');

      const { data: allJualan } = await supabase.from('jualan').select('*');

      const userId = userData.pendaftar_id;
      const userJualan = allJualan.filter(j => j.pendaftar_id === userId);
      const userReferral = allPendaftar.filter(p => p.referral === userId);

      const jumlahJualan = userJualan.reduce((sum, j) => sum + j.jumlah, 0);
      const jumlahReferral = userReferral.length;

      let tier = 1;
      if (jumlahJualan >= 10000 && jumlahReferral >= 10) tier = 5;
      else if (jumlahJualan >= 8000 && jumlahReferral >= 5) tier = 4;
      else if (jumlahJualan >= 5000 && jumlahReferral >= 3) tier = 3;
      else if (jumlahJualan >= 3000) tier = 2;

      const komisen = komisenByTier[tier] + '%';
      const override = tier >= 3 ? 'Ya' : 'Tidak';

      const rankingTable = document.getElementById('ranking-table');
      rankingTable.innerHTML = '';

      allPendaftar.forEach((pendaftar, index) => {
        const referralCount = allPendaftar.filter(p => p.referral === pendaftar.pendaftar_id).length;
        const jualanCount = allJualan
          .filter(j => j.pendaftar_id === pendaftar.pendaftar_id)
          .reduce((sum, j) => sum + j.jumlah, 0);

        let pTier = 1;
        if (jualanCount >= 10000 && referralCount >= 10) pTier = 5;
        else if (jualanCount >= 8000 && referralCount >= 5) pTier = 4;
        else if (jualanCount >= 5000 && referralCount >= 3) pTier = 3;
        else if (jualanCount >= 3000) pTier = 2;

        rankingTable.innerHTML += `
          <tr${pendaftar.pendaftar_id === userId ? ' class="table-info"' : ''}>
            <td>${index + 1}</td>
            <td>${pendaftar.name}</td>
            <td>${pendaftar.pendaftar_id}</td>
            <td>${referralCount}</td>
            <td>RM${jualanCount}</td>
            <td>${pTier}</td>
            <td>${komisenByTier[pTier]}%</td>
            <td>${pTier >= 3 ? 'Ya' : 'Tidak'}</td>
          </tr>
        `;
      });
    }

    function logout() {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }

    getDashboardData();
  </script></body>
</html>