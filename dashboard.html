<!DOCTYPE html><html lang="ms">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Komisen & Tier</title>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";const supabase = createClient(
  "https://qdyojftztydvhyjbdnaq.supabase.co",
  "***REMOVED***"
);

const userId = localStorage.getItem("pendaftarID");
const userNama = localStorage.getItem("userNama");
document.getElementById("user-nama").innerText = userNama || "";
document.getElementById("user-id").innerText = userId || "";

async function loadDashboard() {
  const { data: user } = await supabase
    .from("pendaftar")
    .select("*, referral")
    .eq("pendaftar_id", userId)
    .single();

  const { data: referrals } = await supabase
    .from("pendaftar")
    .select("referral")
    .eq("referral", userId);

  const { data: purchases } = await supabase
    .from("pembelian")
    .select("jumlah")
    .eq("pendaftar_id", userId);

  const totalReferral = referrals.length;
  const totalSales = purchases.reduce((sum, p) => sum + (p.jumlah || 0), 0);

  let tier = 1;
  let komisen = 10;
  let override = "❌";

  if (totalSales >= 3000) {
    tier = 2; komisen = 13;
  }
  if (totalSales >= 5000 && totalReferral >= 3) {
    tier = 3; komisen = 15; override = "✅";
  }
  if (totalSales >= 8000 && totalReferral >= 5) {
    tier = 4; komisen = 18; override = "✅";
  }
  if (totalSales >= 10000 && totalReferral >= 10) {
    tier = 5; komisen = 20; override = "✅";
  }

  document.getElementById("total-sale").innerText = `RM ${totalSales.toFixed(2)}`;
  document.getElementById("total-referral").innerText = totalReferral;
  document.getElementById("current-tier").innerText = tier;
  document.getElementById("komisen").innerText = komisen + "%";
  document.getElementById("override").innerText = override;
}

loadDashboard();

  </script>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    .stat { margin: 10px; font-size: 18px; }
    h2 { color: purple; }
  </style>
</head>
<body>
  <h2>Dashboard Anda</h2>
  <p>Nama: <b><span id="user-nama"></span></b> | ID: <b><span id="user-id"></span></b></p>  <div class="stat">Jumlah Jualan: <span id="total-sale">Loading...</span></div>
  <div class="stat">Jumlah Referral: <span id="total-referral">Loading...</span></div>
  <div class="stat">Tier Semasa: <span id="current-tier">Loading...</span></div>
  <div class="stat">Komisen: <span id="komisen">Loading...</span></div>
  <div class="stat">Override Komisen: <span id="override">Loading...</span></div>
</body>
</html>