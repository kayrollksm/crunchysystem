const supabaseUrl = "https://qdyojftztydvhyjbdnaq.supabase.co";
const supabaseKey = "***REMOVED***";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

document.addEventListener("DOMContentLoaded", async () => {
  const pendaftar_id = localStorage.getItem("pendaftar_id");
  const nama = localStorage.getItem("nama");
  const batch = localStorage.getItem("batch");

  // 🛡 Redirect ke login kalau tiada session
  if (!pendaftar_id || !nama) {
    window.location.href = "login.html";
    return;
  }

  // 🧾 Papar data pengguna
  document.getElementById("nama-user").textContent = nama ?? "-";
  document.getElementById("id-user").textContent = pendaftar_id ?? "-";
  document.getElementById("batch-user").textContent = batch ?? "-";

  // 📊 Jumlah referral
  const { count, error: referralErr } = await supabase
    .from("pendaftar")
    .select("id", { count: "exact" })
    .eq("referral", pendaftar_id);

  if (!referralErr) {
    document.getElementById("jumlah-referral").textContent = count ?? 0;
  } else {
    document.getElementById("jumlah-referral").textContent = "0";
  }

  // 🏆 Papar Top 10 Referrer
  const { data: topData, error: topErr } = await supabase
    .from("pendaftar")
    .select("nama, total_referral")
    .order("total_referral", { ascending: false })
    .limit(10);

  const topList = document.getElementById("top10-list");
  topList.innerHTML = "";

  if (!topErr && topData.length > 0) {
    topData.forEach((user, index) => {
      const li = document.createElement("li");
      li.textContent = `${index + 1}. ${user.nama} – ${user.total_referral ?? 0} referral`;
      topList.appendChild(li);
    });
  } else {
    topList.innerHTML = "<li>Tiada data.</li>";
  }
});

// 🔓 Logout
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}